{% extends "admin_layout.html" %}

{% block admin_content %}
<div class="glass-card_header" style="margin-bottom: 2rem;">
    <a href="/admin/candidates" style="color: #94a3b8; text-decoration: none;">&larr; Back to Candidates</a>
    <h2>➕ Add New Candidate</h2>
</div>

<div class="glass-card" style="max-width: 800px; margin: 0 auto;">
    <h3>➕ Add New Candidate Pair</h3>
    <p>Fill in the details for the Regional Head Election (Kepala Daerah).</p>

    <form id="addCandidateForm" enctype="multipart/form-data">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label>Candidate Name (Ketua)</label>
                <input type="text" name="name" placeholder="E.g., Dr. Alice" required>
            </div>
            <div>
                <label>Vice Candidate Name (Wakil)</label>
                <input type="text" name="vice_name" placeholder="E.g., Mr. Bob" required>
            </div>
        </div>

        <label>Tagline / Slogan (Short Description)</label>
        <input type="text" name="description" placeholder="E.g., Towards a Golden Future" required>

        <label>Vision (Visi)</label>
        <textarea name="vision"
            style="width: 100%; height: 80px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 10px; padding: 10px;"
            placeholder="Enter Vision..."></textarea>

        <label style="margin-top: 1rem; display: block;">Mission (Misi)</label>
        <textarea name="mission"
            style="width: 100%; height: 120px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 10px; padding: 10px;"
            placeholder="Enter Mission..."></textarea>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div>
                <label style="display: block;">Photo Ketua</label>
                <input type="file" name="image" accept="image/*" required
                    style="padding: 10px; width: 100%; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
            </div>
            <div>
                <label style="display: block;">Photo Wakil</label>
                <input type="file" name="image_vice" accept="image/*" required
                    style="padding: 10px; width: 100%; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
            </div>
        </div>

        <button type="submit" class="btn-vote" style="margin-top: 2rem;">Submit Candidate to Blockchain</button>
    </form>
</div>

<script>
    // --- IMAGE VALIDATION LOGIC ---
    function validateImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const img = new Image();
            img.src = window.URL.createObjectURL(file);

            img.onload = function () {
                const width = this.width;
                const height = this.height;
                window.URL.revokeObjectURL(this.src);

                // Validation Threshold: 1080x1350
                if (width < 1080 || height < 1350) {
                    Swal.fire({
                        title: 'Image Resolution Too Low',
                        text: `Current: ${width}x${height}px.\nMinimum required: 1080x1350px (Portrait 4:5).`,
                        icon: 'warning',
                        confirmButtonColor: '#f59e0b'
                    });
                    input.value = ""; // Reset input
                }
            }
        }
    }

    // Attach listeners
    document.querySelector('input[name="image"]').addEventListener('change', function () {
        validateImage(this);
    });
    document.querySelector('input[name="image_vice"]').addEventListener('change', function () {
        validateImage(this);
    });

    // --- FORM SUBMISSION ---
    document.getElementById('addCandidateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "Processing Transaction & Uploading...";
        btn.disabled = true;

        const formData = new FormData(e.target);

        try {
            const response = await fetch('/admin/add', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: "Candidate Added & Synced to Blockchain!",
                    icon: 'success'
                }).then(() => {
                    window.location.href = "/admin/candidates";
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: data.error,
                    icon: 'error'
                });
            }
        } catch (err) {
            Swal.fire({
                title: 'Network Error',
                text: "Could not connect to server.",
                icon: 'error'
            });
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });
</script>
{% endblock %}