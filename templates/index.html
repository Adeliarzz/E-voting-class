{% extends "layout.html" %}

{% block content %}
<!-- Hero Section -->
<div style="text-align: center; margin: 3rem 0 5rem;">
    <h1
        style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(to right, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; letter-spacing: -1px;">
        Choose Your Leader
    </h1>
    <p style="color: #cbd5e1; font-size: 1.2rem; max-width: 600px; margin: 0 auto 2rem;">
        Secure, Transparent, and Immutable Voting on the Blockchain. <br>
        Every vote counts towards the future.
    </p>

    <!-- Countdown Timer -->
    <div class="glass-card"
        style="display: inline-flex; gap: 2rem; padding: 1.5rem 3rem; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="text-align: center;">
            <span id="hours" style="font-size: 2.5rem; font-weight: 700; display: block; line-height: 1;">00</span>
            <small
                style="text-transform: uppercase; font-size: 0.7rem; color: #94a3b8; letter-spacing: 2px;">Hours</small>
        </div>
        <div style="font-size: 2.5rem; font-weight: 300; opacity: 0.5;">:</div>
        <div style="text-align: center;">
            <span id="minutes" style="font-size: 2.5rem; font-weight: 700; display: block; line-height: 1;">00</span>
            <small
                style="text-transform: uppercase; font-size: 0.7rem; color: #94a3b8; letter-spacing: 2px;">Mins</small>
        </div>
        <div style="font-size: 2.5rem; font-weight: 300; opacity: 0.5;">:</div>
        <div style="text-align: center;">
            <span id="seconds" style="font-size: 2.5rem; font-weight: 700; display: block; line-height: 1;">00</span>
            <small
                style="text-transform: uppercase; font-size: 0.7rem; color: #94a3b8; letter-spacing: 2px;">Secs</small>
        </div>
        <div style="font-size: 2.5rem; font-weight: 300; opacity: 0.5;">.</div>
        <div style="text-align: center;">
            <span id="milliseconds"
                style="font-size: 2.5rem; font-weight: 700; display: block; line-height: 1; color: var(--accent-color);">000</span>
            <small style="text-transform: uppercase; font-size: 0.7rem; color: #94a3b8; letter-spacing: 2px;">Ms</small>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; padding: 0 1rem;">
    {% for candidate in candidates %}
    <div class="glass-card candidate-card"
        style="padding: 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease;">

        <!-- Image Header (Split) -->
        <!-- Image Header (Split) -->
        <div class="candidate-img-container"
            style="height: 280px; width: 100%; position: relative; overflow: hidden; display: flex;">
            <div style="flex: 1; height: 100%; position: relative;">
                <img src="{{ url_for('static', filename='uploads/' + candidate.image_file) }}" alt="Ketua"
                    style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%;">
                <div
                    style="position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); color: white; text-align: center; font-size: 0.8rem; padding: 10px 2px 2px;">
                    KETUA</div>
            </div>
            <div style="flex: 1; height: 100%; position: relative; border-left: 1px solid rgba(255,255,255,0.2);">
                <img src="{{ url_for('static', filename='uploads/' + (candidate.image_vice if candidate.image_vice else 'default.jpg')) }}"
                    alt="Wakil" style="width: 100%; height: 100%; object-fit: cover; object-position: center 20%;">
                <div
                    style="position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); color: white; text-align: center; font-size: 0.8rem; padding: 10px 2px 2px;">
                    WAKIL</div>
            </div>

            {% if user and user.has_voted and user.voted_candidate_id == candidate.id %}
            <div
                style="position: absolute; top: 15px; right: 15px; background: #22c55e; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid white; z-index: 10;">
                ‚úÖ YOUR CHOICE
            </div>
            {% endif %}
        </div>

        <!-- Content Body -->
        <div style="padding: 1.5rem;">
            <h3 style="margin: 0 0 5px; font-size: 1.4rem;">{{ candidate.name }}</h3>
            <p style="margin: 0 0 1rem; color: #94a3b8; font-weight: 500;">& {{ candidate.vice_name }}</p>

            <div style="margin-bottom: 1.5rem; text-align: center; min-height: 3rem;">
                <p style="font-style: italic; color: var(--accent-color); font-size: 1rem;">"{{ candidate.description
                    }}"</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <!-- Detail Button -->
                <button onclick="openDetailModal('{{ candidate.id }}')"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 10px; cursor: pointer; transition: background 0.2s;">
                    üìÑ Details
                </button>

                <!-- Vote Action -->
                {% if user %}
                {% if not user.has_voted %}
                <button onclick="vote('{{ candidate.id }}', '{{ candidate.name }}')" class="btn-vote"
                    style="width: 100%; height: 100%;">
                    Vote Now üó≥Ô∏è
                </button>
                {% else %}
                <button disabled
                    style="background: rgba(255,255,255,0.05); color: #64748b; border: 1px solid rgba(255,255,255,0.05); width: 100%; height: 100%; border-radius: 10px; cursor: not-allowed;">
                    Voted
                </button>
                {% endif %}
                {% else %}
                <a href="/login" class="btn-vote"
                    style="display: flex; align-items: center; justify-content: center; text-decoration: none; width: 100%; height: 100%; box-sizing: border-box;">
                    Login to Vote
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Hidden Data for Modal -->
        <div id="data-{{ candidate.id }}" style="display: none;">
            <span class="vision">{{ candidate.vision if candidate.vision else 'No Vision provided.' }}</span>
            <span class="mission">{{ candidate.mission if candidate.mission else 'No Mission provided.' }}</span>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Detail Modal -->
<div id="detailModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="glass-card"
        style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; animation: slideUp 0.3s ease;">
        <button onclick="closeDetailModal()"
            style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>

        <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">üìÑ Candidate Details</h2>

        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">VISION</h4>
            <p id="modalVision" style="color: #94a3b8; margin-top: 5px; white-space: pre-wrap;line-height: 1.6;"></p>
        </div>

        <div>
            <h4 style="color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;">MISSION
            </h4>
            <p id="modalMission" style="color: #94a3b8; margin-top: 5px; white-space: pre-wrap; line-height: 1.6;"></p>
        </div>

        <div style="margin-top: 2rem; text-align: right;">
            <button onclick="closeDetailModal()" class="btn-vote" style="width: auto; padding: 8px 20px;">Close</button>
        </div>
    </div>
</div>

<style>
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    // --- REAL-TIME CLOCK LOGIC ---
    function updateTimer() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();
        const milliseconds = now.getMilliseconds();

        document.getElementById("hours").innerHTML = ("0" + hours).slice(-2);
        document.getElementById("minutes").innerHTML = ("0" + minutes).slice(-2);
        document.getElementById("seconds").innerHTML = ("0" + seconds).slice(-2);
        // Show 3 digits for MS
        document.getElementById("milliseconds").innerHTML = ("00" + milliseconds).slice(-3);
    }

    // Update every 50ms (updating every 10ms is too fast for visual perception/web)
    setInterval(updateTimer, 50);

    // --- MODAL LOGIC ---
    function openDetailModal(id) {
        const dataDiv = document.getElementById('data-' + id);
        const vision = dataDiv.querySelector('.vision').innerText;
        const mission = dataDiv.querySelector('.mission').innerText;

        document.getElementById('modalVision').innerText = vision;
        document.getElementById('modalMission').innerText = mission;

        document.getElementById('detailModal').style.display = 'flex';
    }

    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    window.onclick = function (event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) {
            closeDetailModal();
        }
    }

    // --- SWEETALERT VOTE LOGIC ---
    async function vote(candidateId, candidateName) {
        // 1. Confirm
        const result = await Swal.fire({
            title: 'Confirm Vote?',
            text: `Are you sure you want to vote for ${candidateName}? This action cannot be undone.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            cancelButtonColor: '#ef4444',
            confirmButtonText: 'Yes, Cast Vote!',
            background: '#1e293b',
            color: '#fff'
        });

        if (!result.isConfirmed) return;

        // 2. Loading State
        Swal.fire({
            title: 'Casting Vote...',
            text: 'Signing transaction on Blockchain. Please wait.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            },
            background: '#1e293b',
            color: '#fff'
        });

        try {
            const response = await fetch('/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ candidate_id: candidateId })
            });

            const data = await response.json();

            if (data.success) {
                // 3. Success
                await Swal.fire({
                    title: 'Vote Successful!',
                    text: `Transaction Hash: ${data.tx_hash.substring(0, 10)}...`,
                    icon: 'success',
                    confirmButtonColor: '#22c55e',
                    background: '#1e293b',
                    color: '#fff'
                });
                window.location.reload();
            } else {
                // 4. Server Error
                Swal.fire({
                    title: 'Vote Failed',
                    text: data.error,
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        } catch (e) {
            // 5. Network Error
            Swal.fire({
                title: 'Error',
                text: 'Network connection failed.',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }
</script>
{% endblock %}